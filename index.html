<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>降水ナウキャスト</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="icon" href="favicon.ico">
  <link rel="apple-touch-icon" href="favicon.ico">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    .leaflet-tile { image-rendering: pixelated; }
    .leaflet-tile.carto-tile { filter: brightness(0.57) contrast(3.5) saturate(0); }
    .leaflet-tile.gsi-tile { filter: grayscale(100%) !important; }
    #clock {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.70);
      padding: 10px;
      border-radius: 5px;
      font-size: 14px;
      font-family: Arial, sans-serif;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="clock"></div>
  <img src="legend_jp_deep_hrpns.svg" alt="凡例"
       style="position:absolute; top:55px; left:10px; width:65px; background:rgba(255,255,255,0.70); padding:4px; border-radius:4px; z-index:1000;">

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const TILE_SIZE = 256;
    const ZOOM_SCALE = {3:1.5,5:1.25,7:1.2,9:1.125,11:1.1,12:1.2,13:1.3,14:1.4,15:1.5,16:1.6};
    let latestTime1 = '', latestTime2 = '';

    async function fetchLatestTimes() {
      try {
        const res = await fetch('https://www.jma.go.jp/bosai/jmatile/data/nowc/targetTimes_N1.json');
        const data = await res.json();
        if(data && data.length > 0){
          const newTime1 = data[0].basetime;
          const newTime2 = data[0].validtime;
          const changed = newTime1 !== latestTime1 || newTime2 !== latestTime2;
          latestTime1 = newTime1;
          latestTime2 = newTime2;
          return changed;
        }
      } catch(e){}
      return false;
    }

    const jmaUrlTemplate = (z,x,y) => {
      if(!latestTime1 || !latestTime2) return ``;
      return `https://www.jma.go.jp/bosai/jmatile/data/nowc/${latestTime1}/none/${latestTime2}/surf/hrpns/${z}/${x}/${y}.png`;
    };

    const NowcastLayer = L.GridLayer.extend({
      createTile: function(coords) {
        const z = coords.z;
        const tile = document.createElement('div');
        tile.style.width = TILE_SIZE + 'px';
        tile.style.height = TILE_SIZE + 'px';

        if(z % 2 === 0 && z <= 10){
          const url = jmaUrlTemplate(z, coords.x, coords.y);
          tile.style.backgroundImage = `url("${url}")`;
          tile.style.backgroundSize = "100% 100%";
        } else {
          let zParent, xParent, yParent;
          if(z <= 10){
            zParent = z - 1; xParent = Math.floor(coords.x/2); yParent = Math.floor(coords.y/2);
          } else {
            zParent = 10;
            const scaleFactor = Math.pow(2, z-10);
            xParent = Math.floor(coords.x/scaleFactor);
            yParent = Math.floor(coords.y/scaleFactor);
          }
          const url = jmaUrlTemplate(zParent, xParent, yParent);
          const factor = z > 10 ? Math.pow(2, z-10) : 2;
          tile.style.backgroundImage = `url("${url}")`;
          tile.style.backgroundSize = (TILE_SIZE * factor) + "px " + (TILE_SIZE * factor) + "px";
          tile.style.backgroundPosition = (-(coords.x % factor) * TILE_SIZE) + "px " + (-(coords.y % factor) * TILE_SIZE) + "px";
          const scale = ZOOM_SCALE[z] || 1.0;
          tile.style.transformOrigin = "top left";
          tile.style.transform = `scale(${scale})`;
        }

        return tile;
      }
    });

    const map = L.map('map', {
      center: [34.5, 134.5],
      zoom: 4,
      minZoom: 4,
      maxZoom: 16,
      zoomControl: false,
      attributionControl: false
    });

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{@2x}.png', {
      maxZoom: 16,
      attribution: '',
    }).on('tileload', e => e.tile.classList.add('carto-tile')).addTo(map);

    L.tileLayer('https://www.jma.go.jp/bosai/jmatile/data/map/none/none/none/surf/mask/{z}/{x}/{y}.png', {
      maxZoom: 16,
      opacity: 1.0,
      attribution: '',
    }).on('tileload', e => e.tile.classList.add('gsi-tile')).addTo(map);

    const nowcastLayer = new NowcastLayer({opacity:0.77}).addTo(map);

    (async () => {
      await fetchLatestTimes();
      nowcastLayer.redraw();
    })();

    setInterval(async () => {
      const changed = await fetchLatestTimes();
      if(changed) nowcastLayer.redraw();
    }, 100);

    function updateClock() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      const dateStr = `${year}-${month}-${day}`;
      const timeStr = `${hours}:${minutes}:${seconds}`;
      document.getElementById('clock').textContent = `${dateStr} ${timeStr}`;
    }
    setInterval(updateClock, 100);
    updateClock();
  </script>
</body>
</html>
